/*

  PovShakeStickKit
  My annotation of the example code originally written by Zheng Zhong Xing ??? (aka zhengzhongxing39)
  Original source obtained from http://pan.baidu.com/share/link?shareid=532839&uk=1161248057
  Licence "unknown" but appears to have been released into the public domain.

  For more info and circuit diagrams see https://github.com/tardate/LittleArduinoProjects/tree/master/Electronics101/PovShakeStickKit

 */

#include <AT89X52.h>
#define uchar unsigned char
#define uint unsigned int   // Macro definitions
#define KEY P3_7            // Definition screen switching button
                            // The input pin that the display selector switch is attached to.
                            // Note that it is declared as P3_0 here. In the product kits I've seen,
                            // it is actually on P3_7


uchar KY;             // KY tracks the back and forth swing interrupt counts, explained later
uchar disp;           // Characters display pointer
uchar pic=0,num=0;    // pic for the number of key presses
                      // num is used to count interrupts



/*
  byte arrays define the various display messages possible
*/
uchar code love[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x3F,0x00,0x20,0x00,0x20,0x00,0x20,
0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x0F,
0x04,0x10,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x04,0x10,0xF8,0x0F,0x00,0x00,
0x00,0x00,0x00,0x00,0xFE,0x07,0x00,0x08,0x00,0x10,0x00,0x20,0x00,0x20,0x00,0x10,
0x00,0x08,0xFE,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x3F,0x82,0x20,0x82,0x20,
0x82,0x20,0x82,0x20,0x82,0x20,0x82,0x20,0x82,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*LOVE*/
};

uchar code loveyou[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x78,0x00,0xFC,0x00,0xFE,0x01,0xFE,0x03,0xFE,0x07,0xFE,0x0F,0xFE,0x1F,0xFC,0x3F,
0xF8,0x7F,0xFC,0x3F,0xFE,0x1F,0xFE,0x0F,0xFE,0x07,0xFE,0x03,0xFE,0x01,0xFC,0x00,
0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*Heart-shaped pattern*/
};

uchar code hehe[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x01,0x40,0x01,0xC0,0x01,0x00,0x00,0x00,0x00,
0xF0,0x0F,0x08,0x10,0x04,0x20,0x00,0x00,0x00,0x00,0xF0,0x3F,0x08,0x00,0x04,0x00,
0x04,0x00,0x04,0x00,0x08,0x00,0xF0,0x3F,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x20,
0x00,0x20,0x00,0x20,0x00,0x20,0x00,0x00,0x00,0x00,0xF0,0x3F,0x08,0x00,0x04,0x00,
0x04,0x00,0x04,0x00,0x08,0x00,0xF0,0x3F,0x00,0x00,0x00,0x00,0x04,0x20,0x08,0x10,
0xF0,0x0F,0x00,0x00,0x00,0x00,0xC0,0x01,0x40,0x01,0xC0,0x01,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*Hehe o(n_n)o pattern*/
};


// Welcome to the magical fantasy shake stick!
unsigned char code hanzi[] = {
//-- Welcome --
      0x04,0x10,0x34,0x08,0xC4,0x06,0x04,0x01,
      0xC4,0x82,0x3C,0x8C,0x20,0x40,0x10,0x30,
      0x0F,0x0C,0xE8,0x03,0x08,0x0C,0x08,0x10,
      0x28,0x60,0x18,0xC0,0x00,0x40,0x00,0x00,
//-- To --
      0x40,0x00,0x42,0x40,0x44,0x20,0xC8,0x1F,
      0x00,0x20,0xFC,0x47,0x04,0x42,0x02,0x41,
      0x82,0x40,0xFC,0x7F,0x04,0x40,0x04,0x42,
      0x04,0x44,0xFE,0x63,0x04,0x20,0x00,0x00,
//-- Use --
      0x40,0x00,0x20,0x00,0xF8,0xFF,0x07,0x00,
      0x04,0x80,0xF4,0x43,0x14,0x45,0x14,0x29,
      0x14,0x19,0xFF,0x17,0x14,0x21,0x14,0x21,
      0x14,0x41,0xF6,0xC3,0x04,0x40,0x00,0x00,
//-- The --
      0x00,0x80,0x00,0x60,0xFE,0x1F,0x22,0x02,
      0x22,0x02,0x22,0x02,0x22,0x02,0xFE,0x7F,
      0x22,0x02,0x22,0x02,0x22,0x42,0x22,0x82,
      0xFF,0x7F,0x02,0x00,0x00,0x00,0x00,0x00,
//-- Magical --
      0x08,0x01,0x88,0x00,0x49,0x00,0xEE,0xFF,
      0x58,0x00,0x88,0x00,0x00,0x00,0xF8,0x1F,
      0x88,0x08,0x88,0x08,0xFF,0xFF,0x88,0x08,
      0x88,0x08,0xFC,0x1F,0x08,0x00,0x00,0x00,
//-- Fantasy --
      0x40,0x00,0x40,0x00,0x44,0x00,0x44,0x3E,
      0x64,0x12,0x54,0x12,0x4C,0x12,0x47,0x12,
      0x4C,0x3F,0x54,0x42,0x74,0x80,0xC6,0x7F,
      0x44,0x00,0x60,0x00,0x40,0x00,0x00,0x00,
//-- Shake --
      0x00,0x40,0x00,0x30,0xFE,0x8F,0x4A,0x80,
      0xAA,0x5F,0x9A,0x4A,0xFE,0x2A,0xAA,0x1A,
      0xCB,0x0F,0xAA,0x7A,0xFE,0x8A,0x9A,0xAA,
      0xAA,0x8F,0x6B,0x80,0x22,0xE0,0x00,0x00,
//-- Stick --
      0x80,0x20,0xC0,0x30,0xA0,0x28,0x98,0x24,
      0x87,0x22,0x80,0x21,0xC4,0x30,0x04,0x60,
      0x04,0x00,0x04,0x20,0x04,0x40,0x04,0x80,
      0x04,0x40,0xFE,0x3F,0x04,0x00,0x00,0x00,
//-- Shake --
      0x10,0x02,0x10,0x42,0x10,0x81,0xFF,0x7F,
      0x90,0x04,0x54,0x05,0xCC,0xF4,0xB4,0x44,
      0x84,0x44,0xBC,0x7F,0x82,0x44,0xA2,0x44,
      0x9B,0xF4,0x82,0x06,0x00,0x04,0x00,0x00,
//-- Shake --
      0x10,0x02,0x10,0x42,0x10,0x81,0xFF,0x7F,
      0x90,0x04,0x54,0x05,0xCC,0xF4,0xB4,0x44,
      0x84,0x44,0xBC,0x7F,0x82,0x44,0xA2,0x44,
      0x9B,0xF4,0x82,0x06,0x00,0x04,0x00,0x00,
//-- Stick --
      0x10,0x04,0x10,0x03,0xD0,0x00,0xFF,0xFF,
      0x90,0x00,0x54,0x05,0x44,0x12,0xD4,0x15,
      0x74,0x14,0x5F,0xFF,0xD4,0x14,0x54,0x15,
      0x56,0x12,0x44,0x06,0x40,0x02,0x00,0x00,
//-- ! --
      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00,0x7C,0x10,0xFE,0x3B,
      0xFE,0x3B,0x7C,0x10,0x00,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/*****Function declarations*****/
void display1(void);
void display2(void);
void display3(void);
void display4(void);

/*****n (us) delay subroutine*****/
// a NOP loop to insert a timing delay
void DelayUs(uint N)
{
  uint x;
  for(x=0; x<=N;x++);
}

/*****Interrupt service routine*****/
// interrupt service routine for INT0 (P3.2)
void intersvr0(void) interrupt 0 using 1
{
  KY=~KY;      // Each rocking back and forth in the mercury switch (or gyro vibration switch)
               // will swing both ends falling edge interrupts, extract only once (from left to right to shake display)
  if(KY==0)
  {
    num++;     // Count the number of interrupts
    switch(pic)      // Select display pattern
    {
      case 0:{display1();}break;
      case 1:{display2();}break;
      case 2:{display3();}break;
      case 3:{display4();}break;
      default:{display1();}
    }
  }
}

/*****Display subroutine 1 (Chinese characters)*****/
void display1(void)
{
  uchar i;
  if(num>10){disp++;num=0;}     // 12 Chinese characters are displayed in 3 groups (4 each time), switching every 10 interrupts
  if(disp>2)disp=0;
  DelayUs(5200);     // Delay time varies depending on hardware differences, adjust to center the display content
  for(i=0;i<64;i++)
  {
    P0=~hanzi[disp*128+i*2];   // set the first 8 LEDs (on port P0)
    P2=~hanzi[disp*128+i*2+1]; // set the last 8 LEDs (on port P2)
    DelayUs(100);
  }
}

/*****Display subroutine 2 (LOVE)*****/
void display2(void)
{
  uchar i;
  DelayUs(4000);
  for(i=0;i<64;i++)
  {
    P0=~love[i*2];
    P2=~love[i*2+1];
    DelayUs(120);
  }
}

/*****Display subroutine 3 (heart-shaped pattern)*****/
void display3(void)
{
  uchar i;
  DelayUs(4000);
  for(i=0;i<64;i++)
  {
    P0=~loveyou[i*2];
    P2=~loveyou[i*2+1];
    DelayUs(120);
  }
}

/*****Display subroutine 4 (hehe o(n_n)o pattern)*****/
void display4(void)
{
  uchar i;
  DelayUs(4000);
  for(i=0;i<64;i++)
  {
    P0=~hehe[i*2];
    P2=~hehe[i*2+1];
    DelayUs(120);
  }
}

/*****Main function*****/
void main(void)
{
  /*-----------------------------------------------
  Configure INT0 (external interrupt 0) to generate
  an interrupt on the falling-edge of /INT0 (P3.2).
  Enable the EX0 interrupt and then enable the
  global interrupt flag.
  INT0 is used to capture input from the mercury switch or gyro vibration switch
  -----------------------------------------------*/
  IT0=1;     // Configure interrupt 0 for falling edge on /INT0 (P3.2)
  EX0=1;     // Enable EX0 Interrupt
  EA=1;      // Enable Global Interrupt Flag

  KY=0;      // Initialize the INT0 counter
  while(1)   // Main loop only detects key presses
  {
    if(KEY==0)     // Screen switching key is pressed
    {
      DelayUs(10000);     // Key debounce
      if(KEY==0);         // wtf? NOP
      pic++;
      while(KEY==0);      // Damn it, debounce!!?
    }
    if(pic>3)pic=0;
  }
}
/*****END*****/